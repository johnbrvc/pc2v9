#!/bin/bash
# Copyright (C) 1989-2023 PC2 Development Team: John Clevenger, Douglas Lane, Samir Ashoo, and Troy Boudreau.
#
# Purpose:
#   This script installs a Linux service that runs the script to create
#   the cgroup necessary for PC2 sandboxes.  The service is a one-shot service
#   that simply runs the /usr/pc2/bin/pc2installsandbox shell script
#
# Author: John Buck

#DEBUG=
DEBUG="echo Would"

SCRIPTNAME="$0"

if test $# -ne 2
then
	echo Usage: $SCRIPTNAME pc2user pc2group
	exit 4
fi
JUDGE_USER="$1"
JUDGE_GROUP="$2"
if ! getent passwd $JUDGE_USER >/dev/null 2>&1
then
	echo $SCRIPTNAME: No such user $JUDGE_USER.  The pc2user must be a valid login id.
	exit 5
fi
if ! getent group $JUDGE_GROUP >/dev/null 2>&1
then
	echo $SCRIPTNAME: No such group $JUDGE_USER.  The pc2group must be a valid group in /etc/group.
	exit 6
fi

INSTALL_SCRIPT_PATH=/usr/pc2/bin/pc2installsandbox
SERVICE_NAME=pc2_cgroup.service
SERVICE_FILE=/usr/pc2/support/system_cgroup/${SERVICE_NAME}

ServiceError()
{
	echo $SCRIPTNAME: $*
	echo $SCRIPTNAME: Service not installed.
	echo $SCRIPTNAME: For help, please refer to the '"Running in a Sandbox"' Appendix
	echo $SCRIPTNAME: in the \"PC2 Contest Administrator\'s Installation and Configuration Guide\"
}

euid=`id -u`
if test "$euid" -ne 0
then
	echo $SCRIPTNAME: This script must be run as super user
	exit 1
fi
if test ! -s ${SERVICE_FILE}
then
	ServiceError Can not find service file: ${SERVICE_FILE}
	exit 2
fi

if test ! -x ${INSTALL_SCRIPT_PATH}
then
	ServiceError The script ${INSTALL_SCRIPT_PATH} must be present and executable
	exit 3
fi

$DEBUG cp -a ${SERVICE_FILE} /etc/systemd/system
$DEBUG sed -i -e "s/%JUDGEUSER%/$JUDGE_USER/" -e "s/%JUDGEGROUP%/$JUDGE_GROUP/" /etc/systemd/system/${SERVICE_NAME}
$DEBUG systemctl enable ${SERVICE_NAME}
$DEBUG systemctl start ${SERVICE_NAME}
$DEBUG systemctl status ${SERVICE_NAME}
exit 0
